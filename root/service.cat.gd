extends CAT32

var time_pos = [DIS.W - (6 * 8) - 1, 2]

var font_time = "
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777000007700000777700007777000770077007777770007777000777777000777700007777000000000000000000000000000000000000000000000000000
77777700077700007777770077777700770077007777770077777700777777007777770077777700000000000777770000000000000000000000000000000000
77007700777700007700770077007700770077007700000077007700770077007700770077007700000000000770070000000000000000000000000000000000
77007700777700000000770000007700770077007700000077000000000077007700770077007700007700000777770000000000000000000000000000000000
77007700007700000000770000007700770077007700000077000000000077007700770077007700007700000770000000000000000000000000000000000000
77007700007700000000770000007700770077007700000077000000000077007700770077007700007700000770000000000000000000000000000000000000
77007700007700000007770000777000777777007777700077777000000777000777700077777700000000000000000000000000000000000000000000000000
77007700007700000077700000777000077777000777770077777700007770000777700007777700000000000000000000000000000000000000000000000000
77007700007700000777000000007700000077000000770077007700007700007700770000007700007700000700070000000000000000000000000000000000
77007700007700007770000000007700000077000000770077007700007700007700770000007700007700000770770000000000000000000000000000000000
77007700007700007700000000007700000077000000770077007700007700007700770000007700007700000777070000000000000000000000000000000000
77007700007700007700000077007700000077007700770077007700007700007700770077007700000000000770070000000000000000000000000000000000
77777700777777007777770077777700000077007777770077777700007700007777770077777700000000000770070000000000000000000000000000000000
07777000777777007777770007777000000077000777700007777000007700000777700007777000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
"

func init():
	font_time = font_time.strip_escapes().hex_decode()
	tick()

func tick():
	DIS.memsel(DIS.MEM_TOP)
	DIS.clear()

	service_time()

	DIS.flip()
	await timer(1)
	tick()

func service_time():
	var time = Time.get_time_dict_from_system()
	var time_h = time.hour % 12 if time.hour % 12 != 0 else 12
	var time_fmt = (" " if time_h < 10 else "") + str(time_h) + (":" if time.second % 2 == 0 else " ") + str(time.minute).pad_zeros(2)

	var xoff = 0
	for digit in time_fmt:
		var shift = int(digit)
		if digit == ":":
			shift = 10
		if digit == " ":
			xoff += 1
			continue

		DIS.blit(
			font_time,
			128, 16,
			shift * 8, 0, 8, 16,
			DIS.W, DIS.H,
			time_pos[0] + (xoff * 8), time_pos[1], 8, 16,
			0
		)
		xoff += 1

	DIS.blit(
			font_time,
			128, 16,
			11 * 8, 0, 8, 16,
			DIS.W, DIS.H,
			time_pos[0] + (xoff * 8), time_pos[1], 8, 16,
			0
		)

	if time.hour < 12:
		DIS.pixel(time_pos[0] + (xoff * 8) + 5, time_pos[1] + 5, COL.WHITE)
		DIS.pixel(time_pos[0] + (xoff * 8) + 5, time_pos[1] + 6, COL.WHITE)

func update():
	if BTN.get_repeat(BTN.CONTEXT):
		run("/app/file_explorer.cat.gd")
	if BTN.get_repeat(BTN.SYSTEM):
		get_tree().reload_current_scene()
